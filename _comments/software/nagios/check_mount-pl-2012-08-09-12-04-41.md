---
name: 'Anders Holm'
link: 'http://andersholm.me'
date: '2012-08-09 12:04:41'
comment: "First off, sane exiting from the usage statement, in the event someone adds a check, but forgets the mount point..\n\n\n\n{% highlight perl %}\nsub how_to\n{\n	print \"USAGE: $0\\n\\t-m MOUNTPOINT\\twich mountpoint to check\\n\\t[-t TYPE]\\toptionally check whether it's this kind of fs-type\\n\\n\";\n	print \"OK: We really have no idea what you want to check, so we'll play it safe here, alright?\\n\";\n	exit $ERRORS{'OK'};\n}\n{% endhighlight %}\n\n\n\nIn case of a mount point sitting under another like this:\n\n\n\n{% highlight bash %}\n/opt/something mounted from /dev/sdb\n/opt/something/shared mounted from NFS\n{% endhighlight %}\n\n\n\nthen you actually catch both in your $erg grep ... To only catch the one filesystem you are looking for is doing something like this (ugly) hack ..\n\n\n\n{% highlight perl %}\nmy $erg = `mount | grep $MOUNT | awk '{ print \\$3\\\" \\\"\\$5 }' | grep -v ^$MOUNT\\/`;\nchomp $erg; #I tend to get rid of newlines ...\n{% endhighlight %}\n\n\n\nAlso CIFS mounts may lose connectivity to the server sharing the folder, but will recover on its own. In the meantime you'll not be able (of course) to do anything with data in that mountpoint. What distinguishes things is simply a directory listing which will contain nothing but a number of question marks if you do a long listing ( `ls -l` ) ..\n\n\n\n{% highlight bash %}\nuser@host $ ll /opt/some_dir\ntotal 0\n?--------- ? ? ? ?            ? another_dir\n{% endhighlight %}\n\n\n\nSo, I've added a little bit of code, for this specific case (and changed a regexp along the way) ...\n\n\n\n{% highlight perl %}\nif ($erg)\n{\n	if (defined ($TYPE))\n	{\n		if ($erg =~ m/$TYPE/x)\n		{ if ($TYPE eq \"cifs\") {\n			my $fs_listing = `ls -larth $MOUNT`;\n			\n			if ($fs_listing =~ m/\\?/x) {\n				print \"WARNING: \" . $MOUNT . \" is mounted but we cannot access files!!\\n\";\n				exit $ERRORS{'WARNING'};\n			}\n		}\n\n			print \"OK: \" . $MOUNT . \" is mounted! Type is \" . $TYPE . \"\\n\";\n			exit $ERRORS{'OK'};\n		}\n		else\n		{\n			print \"WARNING: \" . $MOUNT . \" is mounted! But type is not \" . $TYPE . \"\\n\";\n			exit $ERRORS{'WARNING'};\n		}\n	}\n	print \"OK: \" . $MOUNT . \" is mounted!\\n\";\n	exit $ERRORS{'OK'};\n}\n{% endhighlight %}\n\n\n\nAppears to be working nicely during initial tests. YMMV..."
post_id: /software/nagios/check_mount-pl

---


